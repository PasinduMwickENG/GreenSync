{
  "rules": {
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "setupCompleted": {
          ".validate": "newData.isBoolean()"
        },
        "farms": {
          "$farmId": {
            ".validate": "newData.hasChildren(['modules']) || !newData.exists()",
            "modules": {
              "$moduleId": {
                ".validate": "newData.hasChildren() || !newData.exists()",
                "crop": {
                  ".validate": "newData.isString()"
                },
                "location": {
                  ".validate": "newData.isString()"
                },
                "createdAt": {
                  ".validate": "newData.isNumber()"
                },
                "sensorReadings": {
                  "$timestamp": {
                    ".validate": "newData.hasChildren(['timestamp']) && newData.child('timestamp').isNumber()",
                    "temperature": {
                      ".validate": "newData.isNumber()"
                    },
                    "humidity": {
                      ".validate": "newData.isNumber()"
                    },
                    "soilMoisture": {
                      ".validate": "newData.isNumber()"
                    },
                    "ph": {
                      ".validate": "newData.isNumber()"
                    },
                    "timestamp": {
                      ".validate": "newData.isNumber()"
                    }
                  }
                },
                "latestReading": {
                  ".validate": "newData.hasChildren(['timestamp'])",
                  "temperature": {
                    ".validate": "newData.isNumber()"
                  },
                  "humidity": {
                    ".validate": "newData.isNumber()"
                  },
                  "soilMoisture": {
                    ".validate": "newData.isNumber()"
                  },
                  "ph": {
                    ".validate": "newData.isNumber()"
                  },
                  "timestamp": {
                    ".validate": "newData.isNumber()"
                  }
                },
                "nodes": {
                  "$nodeId": {
                    ".write": "auth != null",
                    ".read": "auth != null",
                    "temperature": {
                      ".validate": "newData.isNumber()"
                    },
                    "rssi": {
                      ".validate": "newData.isNumber()"
                    },
                    "snr": {
                      ".validate": "newData.isNumber()"
                    },
                    "sequenceId": {
                      ".validate": "newData.isNumber()"
                    },
                    "timestamp": {
                      ".validate": "newData.isNumber()"
                    },
                    "history": {
                      "$recordId": {
                        ".write": "auth != null",
                        ".read": "auth != null",
                        ".validate": "newData.hasChildren() || !newData.exists()"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "dashboardConfig": {
          "plots": {
            "$plotId": {
              ".validate": "newData.hasChildren(['name', 'type', 'modules', 'parameters']) || !newData.exists()"
            }
          },
          "preferences": {
            ".validate": "newData.hasChildren() || !newData.exists()"
          }
        }
      }
    },
    "modules": {
      "$moduleId": {
        ".read": "auth != null && (data.child('assignedTo').val() === auth.uid || !data.exists() || data.child('assignedTo').val() === null || data.child('assignedTo').val() === '')",
        ".write": "auth != null",
        "assignedTo": {
          ".write": "auth != null && (data.val() === null || data.val() === '' || data.val() === auth.uid)",
          ".validate": "newData.isString()"
        },
        "status": {
          ".write": "auth != null",
          ".validate": "newData.isString() && (newData.val() === 'assigned' || newData.val() === 'unassigned')"
        },
        "farmId": {
          ".write": "auth != null",
          ".validate": "newData.isString()"
        },
        "deviceType": {
          ".write": "auth != null",
          ".validate": "newData.isString()"
        },
        "lastRegisteredAt": {
          ".write": "auth != null",
          ".validate": "newData.isNumber()"
        },
        "registeredAt": {
          ".write": "auth != null",
          ".validate": "newData.isNumber()"
        },
        "firmwareVersion": {
          ".write": "auth != null",
          ".validate": "newData.isString()"
        }
      }
    },
    "sensorData": {
      "$farmId": {
        ".read": "auth != null && root.child('users').child(auth.uid).child('farms').child($farmId).exists()",
        ".write": "auth != null && root.child('users').child(auth.uid).child('farms').child($farmId).exists()"
      }
    },
    "actuators": {
      "$farmId": {
        ".read": "auth != null && root.child('users').child(auth.uid).child('farms').child($farmId).exists()",
        ".write": "auth != null && root.child('users').child(auth.uid).child('farms').child($farmId).exists()"
      }
    }
  }
}
